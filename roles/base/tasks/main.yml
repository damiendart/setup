# This file was written by Damien Dart, <damiendart@pobox.com>. This is
# free and unencumbered software released into the public domain. For
# more information, please refer to the accompanying "UNLICENCE" file.

---
- name: Ensure timezone is set correctly
  timezone:
    name: Europe/London

- name: Ensure administrator user account exists
  user:
    append: yes
    name: "{{ administrator_username }}"
    password: "{{ administrator_password | password_hash('sha512') }}"
    update_password: on_create
    groups:
      - sudo

- name: Ensure base packages are installed
  apt:
    force_apt_get: yes
    name:
      - git
      - msmtp-mta
      # Ansible requires Passlib for certain functions.
      - python3-passlib
      - openssh-server
    state: present

- name: Ensure OpenSSH Server UFW profile is active
  ufw:
    name: OpenSSH
    rule: limit
  notify: Restart UFW

- name: Ensure OpenSSH Server doesn't allow passwords or root access
  lineinfile:
    dest: /etc/ssh/sshd_config
    regexp: "^{{ item }}"
    line: "{{ item }} no"
    state: present
  with_items:
    - PasswordAuthentication
    - PermitRootLogin
  notify: Restart OpenSSH Server

- name: Ensure administrator user account SSH keys exist
  authorized_key:
    exclusive: true
    user: "{{ administrator_username }}"
    key: "{{ base__authorised_keys }}"
    state: present

- name: Ensure custom msmtp configuration file exist
  template:
    src: msmtprc.j2
    dest: /etc/msmtprc
    owner: root
    group: root
    # The msmtp configuration file has relaxed permissions as there
    # remain a few places where non-root users require msmtp.
    mode: '0644'
