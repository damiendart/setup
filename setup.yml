---
# Damien Dart's Ansible Playbook
#
# This playbook is used to provision the server I host some simple
# websites on and my development environments.
#
#   - This playbook has been tested on Ubuntu 18.04.
#   - For Ubuntu 18.04 machines, Ansible needs to be told to use Python
#     3 (by setting "ansible_python_interpreter").
#   - Things to do on each machine after running this playbook:
#     - If using Tarsnap, ensure a valid (and ideally a write-only) key
#       file is present at "/root/tarsnap.key".
#     - In each virtual site directory, ensure there are symlinks to
#       valid "fullchain.pem" and "privkey.pem" files. For more
#       information, see the accompanying
#       "templates/apache2/virtualhost.conf.j2" file.
#   - This playbook works with the Mitogen plugin. For more information,
#     see <https://mitogen.readthedocs.io/en/stable/ansible.html>.
#
# This file was written by Damien Dart, <damiendart@pobox.com>. This is
# free and unencumbered software released into the public domain. For
# more information, please refer to the accompanying "UNLICENCE" file.


- hosts: all
  become: yes
  vars_files:
    - secret/vars.yml
  tasks:
    - name: Ensure timezone is set correctly
      timezone:
          name: Europe/London

    - name: Ensure a non-root user exists
      user:
        append: yes
        name: "{{ lookup('env', 'USER') }}"
        # The "password_hash" filter doesn't require passlib.
        password: "{{ lookup('password', 'secret/credentials-' + inventory_hostname + '.txt length=22') | password_hash('sha512')}}"
        update_password: on_create
        groups:
          - sudo

    - name: Ensure SSH keys for non-root user exist
      authorized_key:
        user: "{{ lookup('env', 'USER') }}"
        key: "https://github.com/{{ github_username }}.keys"

    - name: Ensure SSH doesn't allow passwords or root access
      lineinfile:
        dest: /etc/ssh/sshd_config
        regexp: "^{{ item }}"
        line: "{{ item }} no"
        state: present
      with_items:
        - PasswordAuthentication
        - PermitRootLogin
      notify: Restart sshd

    - name: Ensure the Tarsnap deb packaging key is present
      apt_key:
        url: https://pkg.tarsnap.com/tarsnap-deb-packaging-key.asc
        state: present

    - name: "DEV: Ensure the NodeSource package signing key is present"
      apt_key:
        url: https://deb.nodesource.com/gpgkey/nodesource.gpg.key
        state: present
      when: development is defined and development

    - name: Ensure required external repositories are present
      apt_repository:
        repo: "{{ item.repo }}"
        state: present
        filename: "{{ item.filename }}"
      with_items:
        - repo: "deb http://pkg.tarsnap.com/deb/{{ ansible_distribution_release }} ./"
          filename: tarsnap
        - repo: "ppa:certbot/certbot"
          filename: certbot

    - name: "DEV: Ensure development external repositories are present"
      apt_repository:
        repo: "{{ item.repo }}"
        state: present
      with_items:
        - repo: "deb https://deb.nodesource.com/node_10.x {{ ansible_distribution_release }} main"
      when: development is defined and development

    - name: Ensure currently installed packages have been upgraded
      apt:
        update_cache: yes
        cache_valid_time: 3600
        upgrade: yes

    - name: Ensure required packages are installed
      apt:
        name:
          - apache2
          - fail2ban
          # Kirby uses the ImageMagick command-line tools instead of the
          # native PHP extension Imagick.
          - imagemagick
          - goaccess
          - logrotate
          - logwatch
          - monit
          # TODO: Explain what msmtp-mta is?
          - msmtp-mta
            # "php-fpm" is required for HTTP/2 support.
          - php7.2-fpm
            # Kirby 3 requires the following three PHP extensions.
          - php-curl
          - php-gd
          - php-mbstring
          - python-certbot-apache
          - tarsnap
          # As of Debian 9 (and Ubuntu 16.04), everything required for
          # unattended upgrades is installed by default.
          # - unattended-upgrades
        state: present

    - name: Check if Composer is installed
      stat:
        path: /usr/local/bin/composer
      register: composer_bin

    - name: Get Composer installer signature
      uri:
        url: https://composer.github.io/installer.sig
        return_content: true
      register: composer_installer_signature
      when: not composer_bin.stat.exists

    - name: Download Composer installer
      get_url:
        url: https://getcomposer.org/installer
        dest: /tmp/composer-installer.php
        mode: 0755
        checksum: "sha384:{{ composer_installer_signature.content }}"
      when: not composer_bin.stat.exists

    - name: Run Composer installer
      command: php composer-installer.php
      args:
        chdir: /tmp
      when: not composer_bin.stat.exists

    - name: Ensure Composer is in the correct location
      copy:
        dest: /usr/local/bin/composer
        group: root
        mode: "0755"
        owner: root
        remote_src: yes
        src: /tmp/composer.phar
      when: not composer_bin.stat.exists

    - name: Ensure Composer is up-to-date
      command: /usr/local/bin/composer self-update
      register: composer_update
      changed_when: "'Updating to version' in composer_update.stdout"

    - name: Ensure Composer plays nicely with GitHub
      command: "composer config -g github-oauth.github.com {{ composer_github_token }}"

    - name: Ensure Canonical Livepatch is installed
      command: snap install canonical-livepatch

    - name: Get Canonical Livepatch status
      command: canonical-livepatch status
      register: livepatch_status
      ignore_errors: yes

    - name: "PROD: Ensure Canonical Livepatch is enabled"
      command: "canonical-livepatch enable {{ livepatch_key }}"
      when:
        - development is not defined or development == false
        - livepatch_status.stdout is search("Machine is not enabled.")

    - name: "DEV: Ensure development-related packages are installed"
      apt:
        name:
          - python-pip
          - python3-pip
          - ruby
          - ruby-dev
          - nodejs
          - build-essential
          - tig
          - tree
          - shellcheck
        state: present
      when: development is defined and development

    - name: Ensure required Apache modules are enabled
      apache2_module:
        state: present
        name: "{{ item }}"
      with_items:
        - cgid
        - expires
        - headers
        - http2
        - macro
        - mpm_event
        - proxy_fcgi
        - rewrite
        - setenvif
        - ssl
      notify: Restart Apache gracefully

    - name: Ensure unrequired Apache mods are disabled
      apache2_module:
        state: absent
        name: "{{ item }}"
      with_items:
        - mpm_prefork
        - status
      notify: Restart Apache gracefully

    - name: Ensure custom configuration files exists
      template:
        src: "{{ item.src }}"
        dest: "{{ item.dest }}"
        owner: root
        group: root
        mode: "{{ item.mode | default('0644') }}"
      notify: "{{ item.notify | default([]) }}"
      with_items:
        - src: fail2ban/jail.local.j2
          dest: /etc/fail2ban/jail.local
          notify: Restart Fail2ban
        - src: msmtp/msmtprc.j2
          dest: /etc/msmtprc
        - src: logwatch/logwatch.conf.j2
          dest: /etc/logwatch/conf/logwatch.conf
        - src: monit/monitrc.j2
          # The weird name is so this configuration file is loaded last.
          dest: /etc/monit/conf.d/zzz.conf
          notify: Restart Monit
        - src: apache2/apache2.conf.j2
          # The weird name is so this configuration file is loaded last.
          dest: /etc/apache2/conf-available/zzz.conf
          notify: Restart Apache gracefully
        - src: cron/tarsnap.sh.j2
          dest: /etc/cron.daily/tarsnap
          mode: "0755"
        - src: bin/wwwstuff.sh.j2
          dest: /usr/local/bin/wwwstuff
          mode: "0755"

    - name: "DEV: Ensure development configuration files exists"
      template:
        src: "{{ item.src }}"
        dest: "{{ item.dest }}"
        owner: "{{ lookup('env', 'USER') }}"
        group: "{{ lookup('env', 'USER') }}"
        mode: "{{ item.mode | default('0644') }}"
      with_items:
        - src: bash/bash_profile.sh.j2
          dest: /etc/profile.d/bash_profile.sh
      when: development is defined and development

    - name: Ensure the zzz.conf configuration file is active
      command: a2enconf zzz
      args:
        creates: /etc/apache2/conf-enabled/zzz.conf
      notify:
        - Restart Apache gracefully

    - name: Ensure the php7.2-fpm configuration file is active
      command: a2enconf php7.2-fpm
      args:
        creates: /etc/apache2/conf-enabled/php7.2-fpm.conf
      notify:
        - Restart Apache gracefully
        - Reload php-fpm

    - name: Ensure customised Certbot cron job is present
      replace:
        path: /etc/cron.d/certbot
        regexp: "certbot -q renew$"
        replace: "certbot -q renew --webroot --webroot-path /var/www/html --renew-hook 'service apache2 graceful'"

    - name: Ensure ufw is configured
      ufw:
        name: "{{ item.profile }}"
        rule: "{{ item.rule }}"
        state: enabled
      notify: Restart ufw
      with_items:
        - profile: Apache Full
          rule: allow
        - profile: OpenSSH
          rule: limit

    - name: Ensure Apache virtual host folders are present
      file:
        group: "{{ item[1].group }}"
        mode: "{{ item[1].mode }}"
        owner: "{{ item[1].owner }}"
        path: "/var/www/{{ item[0].key }}/{{ item[1].directory }}"
        state: directory
      with_nested:
        # TODO: Find a way to extract just the keys.
        - "{{ lookup('dict', sites) }}"
        - - { directory: "", mode: "0750", owner: "{{ lookup('env', 'USER') }}", group: "www-data" }
          - { directory: "releases", mode: "0750", owner: "{{ lookup('env', 'USER') }}", group: "www-data" }
          - { directory: "shared", mode: "0750", owner: "{{ lookup('env', 'USER') }}", group: "www-data" }
          - { directory: "shared/private", mode: "0750", owner: "{{ lookup('env', 'USER') }}", group: "root" }
          - { directory: "shared/private/ssl", mode: "0750", owner: "{{ lookup('env', 'USER') }}", group: "root" }
          - { directory: "shared/protected", mode: "2750", owner: "{{ lookup('env', 'USER') }}", group: "www-data" }

    - name: Ensure Apache virtual host Kirby-related folders are present
      file:
        group: "www-data"
        mode: "2750"
        owner: "www-data"
        path: "/var/www/{{ item[0].key }}/{{ item[1] }}"
        state: directory
      with_nested:
        # TODO: Find a way to extract just the keys.
        - "{{ lookup('dict', sites) }}"
        - [ "shared/protected/accounts", "shared/protected/content", "shared/protected/sessions" ]
      when: item[0].value.kirby_key is defined

    - name: 'Ensure ".env" files exist'
      file:
        group: "www-data"
        mode: "0640"
        owner: "{{ lookup('env', 'USER') }}"
        path: "/var/www/{{ item.key }}/shared/protected/.env"
        state: touch
      with_dict: "{{ sites }}"

    - name: Get available Let's Encrypt certificates
      command: certbot certificates
      become: yes
      register: certbot_output
    - set_fact:
        lets_encrypt_certificates: "{{ lets_encrypt_certificates | default([]) | union(item | regex_search(': ([^\\s]*)', '\\1')) }}"
      when: item is match('.*Certificate Name:.*')
      with_items: 
        - "{{ certbot_output.stdout_lines }}"

    - name: Ensure site-specific Apache configuration files exist
      template:
        src: apache2/virtualhost.conf.j2
        dest: "/etc/apache2/sites-available/{{ item.key }}.conf"
        owner: root
        group: root
        mode: 0644
      with_dict: "{{ sites }}"

    - name: Ensure site-specific cron helper scripts exist
      template:
        src: cron/www-cron.sh.j2
        dest: "/etc/cron.{{ item }}/www-cron"
        owner: root
        group: root
        mode: 0755
      with_items:
        - hourly
        - daily
        - weekly
        - monthly

    - name: Ensure PHP's maximum upload file size is increased
      lineinfile:
        dest: /etc/php/7.2/fpm/php.ini
        regexp: "^{{ item }}"
        line: "{{ item }} = 20M"
        state: present
      with_items:
        - post_max_size
        - upload_max_filesize
      notify: Reload php-fpm

  handlers:
    # The "service" module does not support graceful restarts.
    - name: Restart Apache gracefully
      command: service apache2 graceful
      args:
        warn: false

    - name: Restart Fail2ban
      service: name=fail2ban state=restarted

    - name: Restart Monit
      service: name=monit state=restarted

    - name: Reload php-fpm
      service: name=php7.2-fpm state=reloaded

    - name: Restart sshd
      service: name=ssh state=restarted

    - name: Restart ufw
      service: name=ufw state=restarted
