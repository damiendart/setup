# {{ ansible_managed }}
#
# This file was written by Damien Dart, <damiendart@pobox.com>. This is
# free and unencumbered software released into the public domain. For
# more information, please refer to the accompanying "UNLICENCE file.

<VirtualHost *:80>
  ServerAdmin {{ email_address }}
  {% if development is defined %}
    ServerName {{ item.key }}.{{ ansible_default_ipv4.address }}.xip.io
  {% else %}
    ServerName {{ item.key }}
    ServerAlias {{ item.value.aliases | join(" ") }}
  {% endif %}

  ErrorLog ${APACHE_LOG_DIR}/{{ item.key }}.error.log
  CustomLog ${APACHE_LOG_DIR}/{{ item.key }}.access.log combined

  {% if development is defined %}
    Redirect permanent "/" "https://{{ item.key }}.{{ ansible_default_ipv4.address }}.xip.io/"
  {% else %}
    Redirect permanent "/" "https://{{ item.key }}/"
  {% endif %}
</VirtualHost>

<IfModule mod_ssl.c>
  <VirtualHost *:443>
    ServerAdmin {{ email_address }}
    {% if development is defined %}
      ServerName {{ item.key }}.{{ ansible_default_ipv4.address }}.xip.io
    {% else %}
      ServerName {{ item.key }}
      ServerAlias {{ item.value.aliases | join(" ") }}
    {% endif %}

    ErrorLog ${APACHE_LOG_DIR}/{{ item.key }}.error.log
    CustomLog ${APACHE_LOG_DIR}/{{ item.key }}.access.log combined

    DocumentRoot /var/www/{{ item.key }}/public

    Include /usr/lib/python3/dist-packages/certbot_apache/options-ssl-apache.conf
    # For more information, see <https://serverfault.com/a/846583>.
    SSLCertificateFile /var/www/{{ item.key }}/fullchain.pem
    SSLCertificateKeyFile /var/www/{{ item.key }}/privkey.pem

    {% if development is not defined %}
      <If "%{HTTP_HOST} != '{{ item.key }}'">
        Redirect permanent "/" "https://{{ item.key }}/"
      </If>
    {% endif %}

    <IfModule mod_headers.c>
      Header always set Strict-Transport-Security "max-age=15552000; includeSubDomains"
    </IfModule>

    {% if item.value.kirby_key is defined %}
      <Directory /usr/local/share/kirby/panel/assets>
        Require all granted
      </Directory>

      Alias "/panel/assets/" "/usr/local/share/kirby/panel/assets/"
    {% endif %}

    # Allow individual site customisations at the virtual host level.
    IncludeOptional /var/www/{{ item.key }}/virtualhost.apache.con[f]

    <Directory /var/www/{{ item.key }}/public>
      <IfModule mod_rewrite.c>
        # Remove groups of slashes.
        RewriteCond %{THE_REQUEST} //
        RewriteRule ^.*$ $0 [L,NE,R=permanent]
        {% if item.value.kirby_key is defined %}
          # Remove query strings from URLs.
          RewriteCond %{QUERY_STRING} !=""
          RewriteRule ^(.*)$ $1? [L,R=permanent]
        {% endif %}
      </IfModule>

      IncludeOptional /var/www/{{ item.key }}/directory.apache.con[f]

      <IfModule mod_rewrite.c>
        RewriteEngine on
        RewriteBase /
        {% if item.value.kirby_key is defined %}
          # Block text files in the "content" folder from being accessed.
          RewriteRule ^assets/(.*)\.(txt|md|mdown)$ index.php [L]
          # Make Kirby Panel links work.
          RewriteCond %{REQUEST_URI} !^/panel/assets/.*
          RewriteRule ^panel/(.*) panel/index.php [L]
          # Make site links work.
          RewriteCond %{REQUEST_FILENAME} !-f
          RewriteCond %{REQUEST_FILENAME} !-d
          RewriteCond %{REQUEST_URI} !^/panel/assets/.*
          RewriteRule ^(.*) index.php [L]
        {% else %}
          # Remove query strings from URLs.
          RewriteCond %{QUERY_STRING} !=""
          RewriteRule ^(.*)$ $1? [L,R=permanent]
        {% endif %}
        # Remove "index.html" and "index.php" from URLs.
        RewriteCond %{REQUEST_FILENAME} -f
        RewriteCond %{THE_REQUEST} ^.*/index\.(html|php)
        RewriteRule ^(.*)index\.(html|php)$ $1 [L,NE,R=permanent]
        # Remove file extensions from some URLs.
        RewriteCond %{REQUEST_FILENAME} -f
        # TODO: Use negative lookahead to combine the two conditions?
        RewriteCond %{THE_REQUEST} !^.*/index\.html
        RewriteCond %{THE_REQUEST} ^.*\.html
        RewriteRule ^(.*).html$ $1 [L,NE,R=permanent]
        RewriteCond %{REQUEST_FILENAME}\.html -f
        RewriteRule ^([^\.]+)$ $1.html [L,NC]
      </IfModule>
    </Directory>

  </VirtualHost>
</IfModule>
