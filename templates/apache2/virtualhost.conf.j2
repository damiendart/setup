# {{ ansible_managed }}
#
# This file was written by Damien Dart, <damiendart@pobox.com>. This is
# free and unencumbered software released into the public domain. For
# more information, please refer to the accompanying "UNLICENCE file.

Define PROJECT_ROOT /var/www/{{ item.key }}
Define SHARED_ROOT /var/www/{{ item.key }}/shared
{% if item.value.wwwstuff_deploy is defined %}
  Include /var/www/{{ item.key }}/current_release.apache2.conf
  Define RELEASE_ROOT /var/www/{{ item.key }}/releases/${DEPLOYED_RELEASE}
{% else %}
  Define RELEASE_ROOT /var/www/{{ item.key }}
{% endif %}

Define QUERY_STRING_WHITELIST_REGEX ""

{% if item.value.wwwstuff_deploy is defined %}
  IncludeOptional ${RELEASE_ROOT}/private/apache2/querystring.apache.con[f]
{% else %}
  IncludeOptional ${RELEASE_ROOT}/querystring.apache.con[f]
{% endif %}

<VirtualHost *:80>
  ServerAdmin {{ email_address }}
  {% if development is defined %}
    ServerName {{ item.key }}.{{ ansible_default_ipv4.address }}.xip.io
  {% else %}
    ServerName {{ item.key }}
    ServerAlias {{ item.value.aliases | join(" ") }}
  {% endif %}

  ErrorLog ${APACHE_LOG_DIR}/{{ item.key }}.error.log
  CustomLog ${APACHE_LOG_DIR}/{{ item.key }}.access.log combined

  {% if development is defined %}
    Redirect permanent "/" "https://{{ item.key }}.{{ ansible_default_ipv4.address }}.xip.io/"
  {% else %}
    Redirect permanent "/" "https://{{ item.key }}/"
  {% endif %}
</VirtualHost>

<IfModule mod_ssl.c>
  <VirtualHost *:443>
    ServerAdmin {{ email_address }}
    {% if development is defined %}
      ServerName {{ item.key }}.{{ ansible_default_ipv4.address }}.xip.io
    {% else %}
      ServerName {{ item.key }}
      ServerAlias {{ item.value.aliases | join(" ") }}
    {% endif %}

    ErrorLog ${APACHE_LOG_DIR}/{{ item.key }}.error.log
    CustomLog ${APACHE_LOG_DIR}/{{ item.key }}.access.log combined

    DocumentRoot ${RELEASE_ROOT}/public

    Include /usr/lib/python3/dist-packages/certbot_apache/options-ssl-apache.conf
    # For more information, see <https://serverfault.com/a/846583>.
    {% if item.value.wwwstuff_deploy is defined %}
      SSLCertificateFile ${SHARED_ROOT}/private/ssl/fullchain.pem
      SSLCertificateKeyFile ${SHARED_ROOT}/private/ssl/privkey.pem
    {% else %}
      SSLCertificateFile ${PROJECT_ROOT}/fullchain.pem
      SSLCertificateKeyFile ${PROJECT_ROOT}/privkey.pem
    {% endif %}

    {% if development is not defined %}
      <If "%{HTTP_HOST} != '{{ item.key }}'">
        Redirect permanent "/" "https://{{ item.key }}/"
      </If>
    {% endif %}

    <IfModule mod_headers.c>
      Header always set Strict-Transport-Security "max-age=15552000; includeSubDomains"
    </IfModule>

    # Allow individual site customisations at the virtual host level.
    {% if item.value.wwwstuff_deploy is defined %}
      IncludeOptional ${RELEASE_ROOT}/private/apache2/virtualhost.apache.con[f]
    {% else %}
      IncludeOptional ${RELEASE_ROOT}/virtualhost.apache.con[f]
    {% endif %}

    <Directory ${RELEASE_ROOT}/public>
      <IfModule mod_rewrite.c>
        RewriteEngine on
        RewriteBase /

        # Remove groups of slashes.
        RewriteCond %{THE_REQUEST} //
        RewriteRule ^.*$ $0 [L,NE,R=permanent]

        # Remove query strings from URLs.
        RewriteCond %{QUERY_STRING} !=""
        <IfDefine QUERY_STRING_WHITELIST_REGEX>
          RewriteCond %{REQUEST_URI} ${QUERY_STRING_WHITELIST_REGEX}
        </IfDefine>
        RewriteRule ^(.*)$ $1? [L,R=permanent]

        # Remove "index.html" and "index.php" from URLs.
        RewriteCond %{REQUEST_FILENAME} -f
        RewriteCond %{THE_REQUEST} ^.*/index\.(html|php)
        RewriteRule ^(.*)index\.(html|php)$ $1 [L,NE,R=permanent]

        # Remove file extensions from some URLs.
        RewriteCond %{REQUEST_FILENAME} -f
        # TODO: Use negative lookahead to combine the two conditions?
        RewriteCond %{THE_REQUEST} !^.*/index\.html
        RewriteCond %{THE_REQUEST} ^.*\.html
        RewriteRule ^(.*).html$ $1 [L,NE,R=permanent]
        RewriteCond %{REQUEST_FILENAME}\.html -f
        RewriteRule ^([^\.]+)$ $1.html [L,NC]
      </IfModule>

      {% if item.value.wwwstuff_deploy is defined %}
        IncludeOptional ${RELEASE_ROOT}/private/apache2/directory.apache.con[f]
      {% else %}
        IncludeOptional ${RELEASE_ROOT}/directory.apache.con[f]
      {% endif %}
    </Directory>
  </VirtualHost>
</IfModule>
