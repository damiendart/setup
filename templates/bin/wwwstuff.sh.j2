#!/bin/bash
# {{ ansible_managed }}
#
# A website deployment doohickey.
#
# TODO: Explain what this script does.
#
# This file was written by Damien Dart, <damiendart@pobox.com>. This is
# free and unencumbered software released into the public domain. For
# more information, please refer to the accompanying "UNLICENCE file.

set -e
unset IFS
umask 0037

USERNAME='{{ lookup('env', 'USER') }}'

log() 
{
  case "$1" in
    error) echo "$(tput bold; tput setaf 7; tput setab 1)ERROR: $2$(tput sgr 0)" >&2 ;;
    info) echo "$(tput setaf 3)INFO: $2$(tput sgr 0)" ;;
    step) echo "$(tput setaf 6)ACTION: $2$(tput sgr 0)" ;;
    success) echo "$(tput setaf 2)SUCCESS: $2$(tput sgr 0)" ;;
  esac
}

BASENAME=$(basename "$0")
COMMAND="$1"
shift

[ -z "$COMMAND" ] && { printf 'No command supplied' >&2; exit 2; }

case "$COMMAND" in
  cleanup)
    USAGE="USAGE: $BASENAME cleanup DOMAIN"
    [ "$#" -lt 1 ] && { printf "Not enough operands\n%s\n" "$USAGE" >&2; exit 2; }
    
    ls -1tr "/var/www/$1/releases" | head -n -4 | while IFS= read -r release; do
      log step "Deleting release $release"
      rm -fr "/var/www/$1/releases/$release"
    done 

    SUCCESS_MESSAGE="$1's releases folder now only contains the four latest releases"
  ;;

  current)
    USAGE="USAGE: $BASENAME current DOMAIN"
    [ "$#" -lt 1 ] && { printf "Not enough operands\n%s\n" "$USAGE" >&2; exit 2; }

    if [[ -f "/var/www/$1/current_release.apache2.conf" ]]; then
      cut -d ' ' -f 3 "/var/www/$1/current_release.apache2.conf"
    else
      log error 'No release has been deployed';
      exit 2;
    fi
  ;;

  deploy)
    USAGE="USAGE: $BASENAME deploy DOMAIN [RELEASE]"
    [ "$#" -lt 1 ] && { printf "Not enough operands\n%s\n" "$USAGE" >&2; exit 2; }

    CURRENT_RELEASE=$(bash "${BASH_SOURCE[0]}" current "$1"  2>/dev/null || echo '')
    RELEASE_TO_DEPLOY="$2"

    if [ -n "$RELEASE_TO_DEPLOY" ]; then
      [ ! -d "/var/www/$1/releases/$RELEASE_TO_DEPLOY" ] &&
          { log error "Release not found"; exit 2; }
      [ "$CURRENT_RELEASE" = "$RELEASE_TO_DEPLOY" ] &&
          { log info "Specified release is already deployed"; exit; }
    else
      RELEASE_TO_DEPLOY=$(ls -1 "/var/www/$1/releases/" | sort | tail -n 1)
      if [ "$CURRENT_RELEASE" = "$RELEASE_TO_DEPLOY" ]; then
        log info 'Latest release is already deployed'
        exit
      else
        log info "Using latest release $RELEASE_TO_DEPLOY"
      fi
    fi

    [ ! -d "/var/www/$1/releases/$RELEASE_TO_DEPLOY/public" ] &&
      { log error "Release does not contain a public folder"; exit 2; }

    if [[ ! "$RELEASE_TO_DEPLOY" =~ .*develop$ ]]; then
      if [ -f "/var/www/$1/releases/$RELEASE_TO_DEPLOY/composer.json" ]; then
        log step "Installing dependencies using Composer"
        composer install --no-dev --working-dir "/var/www/$1/releases/$RELEASE_TO_DEPLOY"

        if grep -q 'getkirby\/cms' "/var/www/$1/releases/$RELEASE_TO_DEPLOY/composer.json"; then
          log step "Creating Kirby-related folders"
          sudo mkdir -p "/var/www/$1/releases/$RELEASE_TO_DEPLOY/protected/cache"
          sudo mkdir -p "/var/www/$1/releases/$RELEASE_TO_DEPLOY/public/media"
        fi
      fi

      bash "${BASH_SOURCE[0]}" permissions "$1" "$RELEASE_TO_DEPLOY"
    fi

    log step "Updating Apache configuration file"
    echo "Define DEPLOYED_RELEASE $RELEASE_TO_DEPLOY" > "/var/www/$1/current_release.apache2.conf"
    sudo chown "$USERNAME:root" "/var/www/$1/current_release.apache2.conf"

    if [ -n "$CURRENT_RELEASE" ]; then
      log step 'Updating deployment history'
      echo "$CURRENT_RELEASE" >> "/var/www/$1/deploy_history"
      sudo chown "$USERNAME:root" "/var/www/$1/deploy_history"
    fi

    log step "Creating convenience symbolic link to deployed release"
    # Atomically update the symbolic link. For more information, see
    # <http://blog.moertel.com/posts/2005-08-22-how-to-change-symlinks-atomically.html>
    sudo ln -s "/var/www/$1/releases/$RELEASE_TO_DEPLOY" "/var/www/$1/tmp"
    sudo mv -Tf "/var/www/$1/tmp" "/var/www/$1/current_release"

    log step 'Gracefully restarting Apache and PHP-FPM'
    sudo apache2ctl -k graceful
    sudo service php7.2-fpm reload

    SUCCESS_MESSAGE="$1 is now live using release $RELEASE_TO_DEPLOY"
    ;;

  init)
    USAGE="USAGE: $BASENAME init DOMAIN [--kirby]"
    [ "$#" -lt 1 ] && { printf "Not enough operands\n%s\n" "$USAGE" >&2; exit 2; }

    log step 'Creating folder structure'
    sudo mkdir -p "/var/www/$1/releases"
    sudo mkdir -p "/var/www/$1/shared/private/ssl"
    sudo mkdir -p "/var/www/$1/shared/protected"
    if [ "$2" = '--kirby' ]; then
      sudo mkdir -p "/var/www/$1/shared/protected/accounts"
      sudo mkdir -p "/var/www/$1/shared/protected/content"
      sudo mkdir -p "/var/www/$1/shared/protected/sessions"
    fi

    log step 'Updating ownerships and permissions'
    sudo chmod 750 "/var/www/$1/"
    sudo chmod 750 "/var/www/$1/releases/"
    sudo chmod 750 "/var/www/$1/shared"
    sudo chmod 2750 "/var/www/$1/shared/protected"
    sudo chmod 750 "/var/www/$1/shared/private"
    sudo chmod 750 "/var/www/$1/shared/private/ssl"
    sudo chown "$USERNAME:www-data" "/var/www/$1/"
    sudo chown "$USERNAME:www-data" "/var/www/$1/releases/"
    sudo chown "$USERNAME:www-data" "/var/www/$1/shared"
    sudo chown "$USERNAME:www-data" "/var/www/$1/shared/protected"
    sudo chown "$USERNAME:root" "/var/www/$1/shared/private"
    sudo chown "$USERNAME:root" "/var/www/$1/shared/private/ssl"
    if [ "$2" = '--kirby' ]; then
      sudo chmod 2750 "/var/www/$1/shared/protected/accounts"
      sudo chmod 2750 "/var/www/$1/shared/protected/content"
      sudo chmod 2750 "/var/www/$1/shared/protected/sessions"
      sudo chown "www-data:www-data" "/var/www/$1/shared/protected/accounts"
      sudo chown "www-data:www-data" "/var/www/$1/shared/protected/content"
      sudo chown "www-data:www-data" "/var/www/$1/shared/protected/sessions"
    fi

    log step 'Creating .env file'
    touch "/var/www/$1/shared/protected/.env"

    if sudo test -d "/etc/letsencrypt/live/$1"; then
      log step "Creating symbolic links to Let's Encrypt certificates"
      sudo ln -s "/etc/letsencrypt/live/$1/fullchain.pem" \
          "/var/www/$1/shared/private/ssl/fullchain.pem"
      sudo ln -s "/etc/letsencrypt/live/$1/privkey.pem" \
          "/var/www/$1/shared/private/ssl/privkey.pem"
    else
      log info "Manual installation of certificates for $1 required!"
    fi

    SUCCESS_MESSAGE="Folder structure for $1 has been created"
    ;;

  permissions)
    USAGE="USAGE: $BASENAME permissions DOMAIN RELEASE"
    [ "$#" -lt 2 ] && { printf "Not enough operands\n%s\n" "$USAGE" >&2; exit 2; }

    log step 'Updating permissions and friends for default files and folders'
    sudo chown "$USERNAME:www-data" "/var/www/$1/releases/$2/"
    sudo find "/var/www/$1/releases/$2/public" -exec chown "$USERNAME:www-data" {} +;
    [ -d "/var/www/$1/releases/$2/private" ] &&
        sudo find "/var/www/$1/releases/$2/private" -exec chown "$USERNAME:root" {} +;
    [ -d "/var/www/$1/releases/$2/protected" ] &&
        sudo find "/var/www/$1/releases/$2/protected" -exec chown "$USERNAME:www-data" {} +;
    find "/var/www/$1/releases/$2/" -type d -exec chmod 0750 {} +;
    find "/var/www/$1/releases/$2/" -type f -exec chmod 0640 {} +;
    [ -d "/var/www/$1/releases/$2/private/bin" ] &&
        find "/var/www/$1/releases/$2/private/bin" -type f -exec chmod 0750 {} +;
    [ -d "/var/www/$1/releases/$2/private/cron" ] &&
        find "/var/www/$1/releases/$2/private/cron" -type f -exec chmod 0750 {} +;

    if grep -sq 'getkirby\/cms' "/var/www/$1/releases/$2/composer.json"; then
      log step 'Updating permissions and friends for Kirby-related files and folders'
      if [ -d "/var/www/$1/releases/$2/protected/cache" ]; then
        sudo find "/var/www/$1/releases/$2/protected/cache" -type d -exec chmod 2750 {} +;
        sudo find "/var/www/$1/releases/$2/protected/cache" -exec chown "www-data:www-data" {} +;
      fi
      if [ -d "/var/www/$1/releases/$2/public/media" ]; then
        sudo find "/var/www/$1/releases/$2/public/media" -type d -exec chmod 2750 {} +;
        sudo find "/var/www/$1/releases/$2/public/media" -exec chown "www-data:www-data" {} +;
      fi
    fi

    SUCCESS_MESSAGE="Permissions and friends updated for $1's $2 release"
    ;;

  rollback)
    USAGE="USAGE: $BASENAME rollback DOMAIN"
    [ "$#" -lt 1 ] && { printf "Not enough operands\n%s\n" "$USAGE" >&2; exit 2; }

    DEPLOY_HISTORY_FILE="/var/www/$1/deploy_history"
    [ ! -f "$DEPLOY_HISTORY_FILE" ] || [ ! -s "$DEPLOY_HISTORY_FILE" ] &&
        { log error "No previously deployed release to rollback to"; exit 2; }
    PREVIOUS_DEPLOY=$(tail -n 1 "$DEPLOY_HISTORY_FILE")
    log info "Reverting to previously deployed release $PREVIOUS_DEPLOY"
    bash "${BASH_SOURCE[0]}" deploy "$1" "$PREVIOUS_DEPLOY"
    sed -i '$ d' "$DEPLOY_HISTORY_FILE"
    sed -i '$ d' "$DEPLOY_HISTORY_FILE"
    SUCCESS_MESSAGE="$1 has been rolled back to release $PREVIOUS_DEPLOY"
    ;;

  setup-dev)
    USAGE="USAGE: $BASENAME setup-dev DOMAIN [FOLDER]"
    [ "$#" -lt 1 ] && { printf "Not enough operands\n%s\n" "$USAGE" >&2; exit 2; }

    PROJECT_DIR=$(readlink -f "${2:-.}")
    TIMESTAMP=$(date +%Y%m%d%H%M%S)
    [ ! -d "$PROJECT_DIR/public" ] &&
        { log error 'A project release must include a public directory'; exit 2; }
    log step 'Creating symlink to project directory'
    ln -s "$PROJECT_DIR" "/var/www/$1/releases/$TIMESTAMP-develop"
    bash "${BASH_SOURCE[0]}" deploy "$1" "$TIMESTAMP-develop"
    SUCCESS_MESSAGE="Development \"release\" created for $1"
    ;;

  stats)
    USAGE="USAGE: $BASENAME stats DOMAIN"
    [ "$#" -lt 1 ] && { printf "Not enough operands\n%s\n" "$USAGE" >&2; exit 2; }

    LOG_FILES=$(find '/var/log/apache2/' -iname "$1.access*")
    [ -z "${LOG_FILES// }" ] && { log error 'No access log files found'; exit 2; }
    zcat -f $LOG_FILES | goaccess --log-format=COMBINED -
    ;;

  upload)
    USAGE="USAGE: $BASENAME upload DOMAIN [FOLDER]"
    [ "$#" -lt 1 ] && { printf 'Not enough operands\n%s\n' "$USAGE" >&2; exit 2; }

    PROJECT_DIR=$(readlink -f "${2:-.}")
    TIMESTAMP=$(date +%Y%m%d%H%M%S)
    [ ! -d "$PROJECT_DIR/public" ] &&
        { log error 'A project release must include a public directory'; exit 2; }
    log step 'Creating and uploading release'
    find "$PROJECT_DIR" -maxdepth 1 \( \( -type f -name composer.\* \) -o \
        \( -type d \( -name public -o -name private -o -name protected \) \) \) -exec basename {} \; |
        tar -czf - --exclude-vcs --exclude-backups -C "$PROJECT_DIR" \
            --exclude='protected/cache' \
            --exclude='protected/site/plugins/kirby-twig' \
            --exclude='protected/vendor' \
            --exclude='public/media' -T - | \
        ssh "$1" "cat > /tmp/$TIMESTAMP.tar.gz \
            && mkdir /var/www/$1/releases/$TIMESTAMP \
            && tar -xzf /tmp/$TIMESTAMP.tar.gz -C /var/www/$1/releases/$TIMESTAMP \
            && rm /tmp/$TIMESTAMP.tar.gz" 
    SUCCESS_MESSAGE="Release $TIMESTAMP uploaded for $1"
    ;;

  *)
    echo "Unknown command" >&2
    exit 2
    ;;
esac

if [[ -n "$SUCCESS_MESSAGE" ]]; then
  # TODO: Explain the following line.
  [[ "$(ps -o args= $PPID)" == *"${BASH_SOURCE[0]}"* ]] || log success "$SUCCESS_MESSAGE"
fi
